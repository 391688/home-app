<!-- ãƒ›ãƒ¼ãƒ ç”»é¢ã§ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³è¡¨ç¤º -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<!-- ãƒ›ãƒ¼ãƒ ç”»é¢ã®ã‚¢ã‚¤ã‚³ãƒ³ -->
<link rel="apple-touch-icon" href="icon.png">

<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚¿ã‚¤ãƒ ç®¡ç†ï¼ˆè¦ªç”¨ï¼‰</title>

<style>
body { font-family: -apple-system, sans-serif; padding: 20px; }
input, button { font-size: 16px; padding: 6px; margin: 2px; }
.box { border: 1px solid #ccc; padding: 12px; margin-bottom: 16px; }
.parentZone { background: #f9f9f9; }
.result { font-size: 18px; font-weight: bold; }
.plus { color: green; }
.minus { color: red; }
.locked { color: #888; }

table { width: 100%; border-collapse: collapse; }
th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
th { background: #f0f0f0; }

ul { padding-left: 20px; }
li button { margin-left: 8px; }
</style>
</head>

<body>

<h1>ğŸ“± ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚¿ã‚¤ãƒ ç®¡ç†ï¼ˆè¦ªç”¨ï¼‰</h1>

<!-- è¦ªæ“ä½œã‚¾ãƒ¼ãƒ³ -->
<div class="box parentZone">
<h2>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ è¦ªç”¨æ“ä½œ</h2>

<h3>ğŸ”’ ãƒ­ãƒƒã‚¯è§£é™¤</h3>
<input type="password" id="passInput" maxlength="4" placeholder="ç¾åœ¨ã®ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰">
<button onclick="unlock()">è§£é™¤</button>
<p id="lockMsg" class="locked"></p>

<h3>ğŸ”‘ ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰å¤‰æ›´</h3>
<input type="password" id="currentPass" maxlength="4" placeholder="ç¾åœ¨ã®ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰"><br>
<input type="password" id="newPass" maxlength="4" placeholder="æ–°ã—ã„ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ï¼ˆ4æ¡ï¼‰"><br>
<input type="password" id="confirmPass" maxlength="4" placeholder="ç¢ºèªç”¨"><br>
<button onclick="changePasscode()">å¤‰æ›´</button>
<p id="passChangeMsg"></p>

<h3>âš™ï¸ ãƒ«ãƒ¼ãƒ«è¨­å®š</h3>
<label>1æ—¥ã®ä¸Šé™æ™‚é–“ï¼ˆåˆ†ï¼‰<br><input type="number" id="dailyLimit"></label><br><br>
<label>æœ€å¤§ãƒœãƒ¼ãƒŠã‚¹ï¼ˆå††ï¼‰<br><input type="number" id="bonusMax"></label><br><br>
<label>è¶…é1åˆ†ã®ãƒšãƒŠãƒ«ãƒ†ã‚£ï¼ˆå††ï¼‰<br><input type="number" id="penaltyPerMin"></label><br><br>
<label>ãƒœãƒ¼ãƒŠã‚¹æ™‚ã®1åˆ†ã‚ãŸã‚ŠåŠ ç®—é¡ï¼ˆå††ï¼‰<br><input type="number" id="bonusPerMin"></label><br><br>
<label>ãƒ™ãƒ¼ã‚¹å°é£ã„ï¼ˆå††ï¼‰<br><input type="number" id="baseAllowance"></label><br><br>
<button onclick="saveSettings()">è¨­å®šä¿å­˜</button>
<p id="settingMsg"></p>

<h3>ğŸ“± é©ç”¨ã‚¢ãƒ—ãƒªè¨­å®š</h3>
<input type="text" id="appInput" placeholder="ã‚¢ãƒ—ãƒªåã‚’å…¥åŠ›">
<button onclick="addApp()">è¿½åŠ </button>
<ul id="appEditList"></ul>

<h3>ğŸ“… æœˆç¢ºå®š</h3>
<p id="fixedMsg"></p>
<button id="fixBtn" onclick="fixMonth()" disabled>ä»Šæœˆã‚’ç¢ºå®šã™ã‚‹</button>
</div>

<!-- é©ç”¨ã‚¢ãƒ—ãƒªè¡¨ç¤º -->
<div class="box">
<h2>ğŸ“² æ™‚é–“è¨ˆç®—ã®å¯¾è±¡ã‚¢ãƒ—ãƒª</h2>
<ul id="appViewList"></ul>
</div>

<!-- æ—¥æ¬¡å…¥åŠ› -->
<div class="box">
<h2>ğŸ“ æ—¥æ¬¡å…¥åŠ›</h2>
<input type="date" id="dateInput">
<button onclick="setToday()">ä»Šæ—¥</button><br><br>
<input type="number" id="usedMinutes" placeholder="ä½¿ç”¨æ™‚é–“ï¼ˆåˆ†ï¼‰"><br><br>
<button id="saveBtn" onclick="save()">ä¿å­˜</button>
<p id="todayResult" class="result"></p>
</div>

<!-- æœˆåˆè¨ˆ -->
<div class="box">
<h2>ğŸ’° ä»Šæœˆã®åˆè¨ˆ</h2>
<p id="monthTotal">0 å††</p>
</div>

<!-- ä¸€è¦§ -->
<div class="box">
<h2>ğŸ“‹ æ—¥åˆ¥ä¸€è¦§</h2>
<table>
<thead><tr><th>æ—¥ä»˜</th><th>ä½¿ç”¨æ™‚é–“</th><th>é‡‘é¡</th></tr></thead>
<tbody id="listBody"></tbody>
</table>
</div>

<script>
// ===== åˆæœŸãƒ‡ãƒ¼ã‚¿ =====
let settings = JSON.parse(localStorage.getItem("screenTimeSettings")) || {
  dailyLimit: 90,
  bonusMax: 100,
  penaltyPerMin: 10,
  bonusPerMin: 5,
  baseAllowance: 100,
  passcode: "1234"
};
let data = JSON.parse(localStorage.getItem("screenTimeData") || "{}");
let fixedMonths = JSON.parse(localStorage.getItem("fixedMonths") || "[]");
let apps = JSON.parse(localStorage.getItem("targetApps") || "[]");

const today = new Date().toISOString().slice(0,10);
dateInput.value = today;

// åˆæœŸåæ˜ 
dailyLimit.value = settings.dailyLimit;
bonusMax.value = settings.bonusMax;
penaltyPerMin.value = settings.penaltyPerMin;
bonusPerMin.value = settings.bonusPerMin;
baseAllowance.value = settings.baseAllowance;

// ===== ãƒ­ãƒƒã‚¯ =====
function unlock() {
  if (passInput.value === settings.passcode) {
    fixBtn.disabled = false;
    lockMsg.textContent = "è§£é™¤ã—ã¾ã—ãŸ";
  } else {
    lockMsg.textContent = "ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™";
  }
}

// ===== ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰å¤‰æ›´ =====
function changePasscode() {
  if (currentPass.value !== settings.passcode) return passChangeMsg.textContent = "ç¾åœ¨ã®ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™";
  if (newPass.value.length !== 4 || isNaN(newPass.value)) return passChangeMsg.textContent = "4æ¡ã®æ•°å­—ã«ã—ã¦ãã ã•ã„";
  if (newPass.value !== confirmPass.value) return passChangeMsg.textContent = "ç¢ºèªç”¨ãŒä¸€è‡´ã—ã¾ã›ã‚“";

  settings.passcode = newPass.value;
  localStorage.setItem("screenTimeSettings", JSON.stringify(settings));
  passChangeMsg.textContent = "å¤‰æ›´ã—ã¾ã—ãŸ";
  currentPass.value = newPass.value = confirmPass.value = "";
}

// ===== ãƒ«ãƒ¼ãƒ«ä¿å­˜ =====
function saveSettings() {
  settings.dailyLimit = Number(dailyLimit.value);
  settings.bonusMax = Number(bonusMax.value);
  settings.penaltyPerMin = Number(penaltyPerMin.value);
  settings.bonusPerMin = Number(bonusPerMin.value);
  settings.baseAllowance = Number(baseAllowance.value);
  localStorage.setItem("screenTimeSettings", JSON.stringify(settings));
  settingMsg.textContent = "ä¿å­˜ã—ã¾ã—ãŸï¼ˆå³åæ˜ ï¼‰";
}

// ===== é©ç”¨ã‚¢ãƒ—ãƒª =====
function addApp() {
  const name = appInput.value.trim();
  if (!name || apps.includes(name)) return;
  apps.push(name);
  saveApps();
  appInput.value = "";
}

function removeApp(i) {
  apps.splice(i, 1);
  saveApps();
}

function saveApps() {
  localStorage.setItem("targetApps", JSON.stringify(apps));
  renderApps();
}

function renderApps() {
  appEditList.innerHTML = "";
  appViewList.innerHTML = "";
  apps.forEach((a, i) => {
    appEditList.innerHTML += `<li>${a}<button onclick="removeApp(${i})">å‰Šé™¤</button></li>`;
    appViewList.innerHTML += `<li>${a}</li>`;
  });
}

// ===== æœˆç¢ºå®š =====
function fixMonth() {
  const m = dateInput.value.slice(0,7);
  if (!confirm(m + " ã‚’ç¢ºå®šã—ã¾ã™ã€‚")) return;
  fixedMonths.push(m);
  localStorage.setItem("fixedMonths", JSON.stringify(fixedMonths));
  updateFixedState();
}

// ===== æ—¥æ¬¡ =====
function setToday(){ dateInput.value = today; showAll(today); }

function save() {
  const d = dateInput.value;
  if (fixedMonths.includes(d.slice(0,7))) return alert("ç¢ºå®šæ¸ˆã¿ã§ã™");
  const used = Number(usedMinutes.value);
  const diff = settings.dailyLimit - used;

  // åæ”¯è¨ˆç®—ï¼ˆãƒœãƒ¼ãƒŠã‚¹å¯¾å¿œï¼‰
  let money = settings.baseAllowance;
  if(diff >= 0) {
    money += Math.min(settings.bonusMax, diff * settings.bonusPerMin);
  } else {
    money += diff * settings.penaltyPerMin;
  }

  data[d] = { used, money };
  localStorage.setItem("screenTimeData", JSON.stringify(data));
  showAll(d);
}

// ===== è¡¨ç¤º =====
function showAll(d){ showDay(d); showMonth(d); showList(d); updateFixedState(); }

function showDay(d){
  if(!data[d]) return;
  todayResult.textContent = `${d}ï¼š${data[d].money} å††`;
  todayResult.className = "result " + (data[d].money>=0?"plus":"minus");
  usedMinutes.value = data[d].used;
}

function showMonth(d){
  let t=0,m=d.slice(0,7);
  Object.keys(data).forEach(k=>{ if(k.startsWith(m)) t+=data[k].money; });
  monthTotal.textContent = `${t} å††`;
}

function showList(d){
  const m=d.slice(0,7);
  listBody.innerHTML="";
  Object.keys(data).filter(k=>k.startsWith(m)).sort().forEach(k=>{
    listBody.innerHTML+=`<tr><td>${k}</td><td>${data[k].used}</td><td class="${data[k].money>=0?"plus":"minus"}">${data[k].money}</td></tr>`;
  });
}

function updateFixedState(){
  const m=dateInput.value.slice(0,7);
  const f=fixedMonths.includes(m);
  fixedMsg.textContent=f?"ã“ã®æœˆã¯ç¢ºå®šæ¸ˆã¿":"";
  saveBtn.disabled=f;
}

dateInput.addEventListener("change",e=>showAll(e.target.value));
renderApps();
showAll(today);
</script>

</body>
</html>